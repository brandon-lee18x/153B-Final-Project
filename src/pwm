#include "stm32l476xx.h"
#include "PWM.h"

static volatile uint32_t ccr = 100;
static volatile short counting_up = 1;
 
void PWM_Init() {
	// Enable GPIO Port A Clock
	// [TODO]
	RCC->AHB2ENR |= RCC_AHB2ENR_GPIOAEN;
	
	// Enable TIM2 Clock
	// [TODO]
	RCC->APB1ENR1 |= RCC_APB1ENR1_TIM2EN;
	
	// Configure PA5
	// [TODO]
	GPIOA->MODER ^= GPIO_MODER_MODE5_0; //0x00000400U
	GPIOA->OSPEEDR |= GPIO_OSPEEDR_OSPEED5; //0x00000C00U
	GPIOA->PUPDR &= ~GPIO_PUPDR_PUPD5; //0x00000C00U
	GPIOA->AFR[0] &= ~GPIO_AFRL_AFSEL5; //clear register
	GPIOA->AFR[0] |= GPIO_AFRL_AFSEL5_0; //0x00100000U
	
	// Configure PWM Output for TIM2 CH 1
	// [TODO]
	TIM2->CR1 &= ~TIM_CR1_DIR; //set to upcounting
	TIM2->PSC = 0x0003;//0x0F9F; //prescaler value
	TIM2->ARR = 1000;
	TIM2->CCMR1 &= ~TIM_CCMR1_OC1M; //clear compare mode bits
	TIM2->CCMR1 |= (TIM_CCMR1_OC1M_1 | TIM_CCMR1_OC1M_2); //0110
	TIM2->CCMR1 |= TIM_CCMR1_OC1PE; //enable output preload
	TIM2->CCER &= ~TIM_CCER_CC1P; //set output polarity to active high
	TIM2->CCER |= TIM_CCER_CC1E; //enable channel 1 output
	TIM2->CCR1 = ccr;
	TIM2->CR1 |= TIM_CR1_CEN; //enable counter
	
}